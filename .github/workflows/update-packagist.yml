name: Sync Packagist on Release

on:
  release:
    types: [published]

jobs:
  packagist:
    runs-on: ubuntu-latest

    steps:
      - name: Sync to Packagist (update or create)
        run: |
          set -e

          echo "üîÑ Tentando atualizar o pacote no Packagist‚Ä¶"
          update_response=$(curl -s -X POST \
            "https://packagist.org/api/update-package?username=${{ secrets.PACKAGIST_USERNAME }}&apiToken=${{ secrets.PACKAGIST_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"repository\":{\"url\":\"https://github.com/${{ github.repository }}\"}}")
          echo "Resposta do update: $update_response"
          
          # Se n√£o vier "status":"success", partimos para o create
          if [[ $update_response != *'"status":"success"'* ]]; then
            echo "‚ö†Ô∏è Update falhou ou pacote n√£o existe. Criando o pacote agora‚Ä¶"
            create_response=$(curl -s -X POST \
              "https://packagist.org/api/create-package?username=${{ secrets.PACKAGIST_USERNAME }}&apiToken=${{ secrets.PACKAGIST_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"repository\":{\"url\":\"https://github.com/${{ github.repository }}\",\"type\":\"vcs\"}}")
            echo "Resposta do create: $create_response"
            if [[ $create_response != *'"status":"success"'* ]]; then
              echo "‚ùå Falha ao criar o pacote no Packagist!"
              exit 1
            fi
            echo "‚úÖ Pacote criado com sucesso no Packagist."
          else
            echo "‚úÖ Pacote existente atualizado com sucesso."
          fi
